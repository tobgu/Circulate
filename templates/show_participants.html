<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Get seated!</title>
  <link rel="stylesheet" type="text/css" href="/static/styles.css">
</head>

<body class="seating-app" ng-app="dragDrop" ng-controller="DragDropCtrl" ng-cloak>
  <div>
    <div class="logo">Get seated!</div>
    <div class="control-panel">
        <label for="simulation-time" class="occasion-select">Duration</label>
        <select id="simulation-time" class="occasion-select" ng-model="simulationTime" ng-options="time.name for time in simulationTimes"></select>
        <label for="colocation-penalty" class="occasion-select">Co-location penalty</label>
        <select id="colocation-penalty" class="occasion-select" ng-model="colocPenalty" ng-options="p for p in penaltyChoices"></select>
        <button class="button occasion-button" ng-class="{ 'command-in-progress' : commandInProgress }" ng-disabled="commandInProgress" ng-click="runSimulation()">Optimize!</button>
        <a href class="occasion-button" ng-click="getResult()">Download result</a>
        <div class="clear">&nbsp;</div>
    </div>
  </div>

  <h1>Seatings per occasion</h1>
  <div>
        <a href class="occasion-link" ng-click="stepOccasion(-1)"><< {{previousOccasion.name}}</a>
        <span class="occasion-name">{{currentOccasion.name}}</span>
        <a href class="occasion-link" ng-click="stepOccasion(1)">{{nextOccasion.name}} >></a>
        <div class="clear">&nbsp;</div>
  </div>
  <div class="occasion">
    <div class="table-div" ng-repeat="table in currentOccasion.tables">
		<table class="table-table">
			<thead>
				<tr>
					<td>Table {{$index + 1}}</td>
				</tr>
			</thead>
			<tbody>
				<tr ng-repeat="participant in table">
					<td colspan="2">
                        <div switchable conference="conference" drop="handleDrop" participant-ix="$index" table-ix="$parent.$index"
                             occasion-ix="currentOccasionIx" class="participant" ng-class="{ 'fix' : participant.fix }"
                             update-grouping="updateGrouping(occasionIx, tableIx)">
                            {{ participant_names[participant.id] }}
                        </div>
                    </td>
                </tr>
                <tr></tr>
                <tr class="group" ng-repeat="count in currentOccasion.groupingData[$index] track by $index" ng-if="count !== undefined">
                    <td>{{ groupNames[$index] }}</td><td>{{ count }}</td>
                </tr>
			</tbody>
		</table>
	</div>
  </div>
  <div class="clear">&nbsp;</div>
  <div>
    <h1>Co-location distribution</h1>
      <table id="hor-minimalist" class="relations-table">
        <thead>
            <tr>
                <td>Co-location count</td><td>Occasions</td>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="(colocCount, count) in relationData">
                <td>{{colocCount}}</td>
                <td>{{count}}</td>
            </tr>
        </tbody>
      </table>

    <h1>Top {{relationsCount}} worst seatings</h1>
    <table id="hor-minimalist" class="relations-table">
        <thead>
            <tr>
                <td>Relation</td><td>Count</td><td>Badness</td><td>Tables</td>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="relation in relations">
                <td>{{ participant_names[relation[0][0]] }} - {{ participant_names[relation[0][1]] }}</td>
                <td>{{ relation[1].length }}</td>
                <td>{{ weightMatrix[relation[0][0]][relation[0][1]] }}</td>
                <td>
                    <div class="colocation-occasion" ng-repeat="coloc in relation[1]" ng-click="setOccasion(coloc[0])">
                        {{ conference[coloc[0]].name }}, table {{ coloc[1] + 1 }} (size {{ coloc[2] }})
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <a class="occasion-link" href ng-click="expandStat()">More...</a>
  </div>
</body>

  <script src='/static/angular.min.js'></script>

  <script>
    var app = angular.module('dragDrop', []);

	app.directive('switchable', function() {
	  return {
		scope: {
		  conference: '=',
		  occasionIx: '=',
		  tableIx: '=',
		  participantIx: '=',
		  updateGrouping: '&'
		},
		link: function(scope, element) {
		  // Get the native object
		  var el = element[0];
		  el.draggable = true;

		  function setTargetAppearence(target, event) {
			  sourceParticipant = scope.conference[scope.conference.dragSourceOccasionIx].tables[scope.conference.dragSourceTableIx][scope.conference.dragSourceParticipantIx];
			  targetParticipant = scope.conference[scope.occasionIx].tables[scope.tableIx][scope.participantIx];

			  if ((scope.conference.dragSourceOccasionIx != scope.occasionIx || sourceParticipant.fix || targetParticipant.fix) && (sourceParticipant != targetParticipant)) {
				target.classList.add('over-nok');
			  } else {
				target.classList.add('over-ok');			  
			  }
			  return false;
		  };

		  function clearTargetAppearance(target) {
			  target.classList.remove('over-ok');
			  target.classList.remove('over-nok');
			  return false;
		  };
		  
		  el.addEventListener(
			'dragover',
			function(e) {
			  e.dataTransfer.dropEffect = 'move';
			  // allows us to drop
			  if (e.preventDefault) e.preventDefault();
			  return setTargetAppearence(this, e);
			},
			false
		  );

		  el.addEventListener(
			'dragenter',
			function(e) {
			  return setTargetAppearence(this, e);
			},
			false
		  );

		  el.addEventListener(
			'dragleave',
			function(e) {
			  return clearTargetAppearance(this);
			},
			false
		  );

		  el.addEventListener(
			'drop',
			function(e) {
			  // Stops some browsers from redirecting.
			  if (e.stopPropagation) e.stopPropagation();

			  clearTargetAppearance(this);
			  sourceParticipant = scope.conference[scope.conference.dragSourceOccasionIx].tables[scope.conference.dragSourceTableIx][scope.conference.dragSourceParticipantIx];
			  targetParticipant = scope.conference[scope.occasionIx].tables[scope.tableIx][scope.participantIx];

			  if (scope.conference.dragSourceOccasionIx != scope.occasionIx || sourceParticipant.fix || targetParticipant.fix) {
				return false;
			  }			  
			  
			  scope.$apply(function(scope) {
				  // Switch the data rather than the actual DOM elements
                  console.log("Dropping");
				  scope.conference[scope.conference.dragSourceOccasionIx].tables[scope.conference.dragSourceTableIx][scope.conference.dragSourceParticipantIx] = targetParticipant;
				  scope.conference[scope.occasionIx].tables[scope.tableIx][scope.participantIx] = sourceParticipant;
			      scope.updateGrouping({occasionIx: scope.conference.dragSourceOccasionIx, tableIx: scope.conference.dragSourceTableIx});
			      scope.updateGrouping({occasionIx: scope.occasionIx, tableIx: scope.tableIx});
			  });
			  
			  return false;
			},
			false
		  );
		  

    	   el.addEventListener(
			  'dragstart',
			  function(e) {
				console.log("Starting to drag: " + scope.occasionIx + ", " + scope.tableIx + ", " + scope.participantIx);
				e.dataTransfer.effectAllowed = 'move';

                // Using variables directly on the scope for communicating which participant
                // is dragged is a hack to work around that Chrome won't allow access to the
                // data in the dataTransfer object for all states.
                scope.conference.dragSourceOccasionIx = scope.occasionIx;
                scope.conference.dragSourceTableIx = scope.tableIx;
                scope.conference.dragSourceParticipantIx = scope.participantIx;

				this.classList.add('drag');
				return false;
			  },
			  false
			);

			el.addEventListener(
			  'dragend',
			  function(e) {
				this.classList.remove('drag');
				return false;
			  },
			  false
			);

			el.addEventListener(
			  'click',
			  function(e) {
				scope.$apply(function(scope) {
				  scope.conference[scope.occasionIx].tables[scope.tableIx][scope.participantIx].fix = !scope.conference[scope.occasionIx].tables[scope.tableIx][scope.participantIx].fix;
			    });
    			
				return false;
			  },
			  false
			);
		}
	  }
	});

	// Conference is made up of occasions with names
//	var xparticipant_names = ["John Doe", "Tom Bom", "Niel Fish", "Locky Bastard", "Joe Johnson", "Any One", "Bom Bom", "Bam Bam", "Pete"];
//	var xconference = [{name: "Sunday", tables: [[{id: 0, fix: false}, {id: 2, fix: false}],
//	                                            [{id: 2, fix: false}, {id: 3, fix: true}]]},
//					  {name: "Monday", tables: [[{id: 4, fix: false}, {id: 5, fix: false}],
//					                            [{id: 6, fix: false}, {id: 7, fix: false}, {id: 8, fix: false}]]}];

 	var participant_names = %%staff_names|safe%%;
    var conference = %%conference|safe%%;
    var relations = %%relations|safe%%;
    var weight_matrix = %%weight_matrix|safe%%;
    var relation_stat = %%relation_stat|safe%%;
    var group_names = %%group_names|safe%%;
    var group_participation = %%group_participation|safe%%;

	app.controller('DragDropCtrl', function($scope,  $http, $document) {
	  $scope.conference = conference;
	  $scope.participant_names = participant_names;
	  $scope.relationsCount = 100;
	  $scope.groupNames = group_names;
	  updateRelationData(relations, relation_stat);
	  updateGroupingData();
	  $scope.currentOccasionIx = 0;
	  $scope.weightMatrix = weight_matrix;

      function updateGroupingData() {
         for(var i=0; i < $scope.conference.length; i++) {
            var occasionGroupingData = [];
            for(var j=0; j < $scope.conference[i]['tables'].length; j++) {
               var tableGroupingData = []
               for(var p=0; p < $scope.conference[i]['tables'][j].length; p++) {
                   var groupMemberships = group_participation[$scope.conference[i]['tables'][j][p].id];
                   for(var g=0; g < groupMemberships.length; g++) {
                       if(tableGroupingData[groupMemberships[g]] !== undefined) {
                          tableGroupingData[groupMemberships[g]]++;
                       } else {
                          tableGroupingData[groupMemberships[g]] = 1;
                       }
                    }
               }
               occasionGroupingData[j] = tableGroupingData;
            }
            $scope.conference[i].groupingData = occasionGroupingData;
         }
      };

      $scope.setOccasion = function(ix) {
	     $scope.currentOccasionIx = ix;
         $scope.currentOccasion = $scope.conference[$scope.currentOccasionIx];
	     $scope.previousOccasion = $scope.conference[($scope.currentOccasionIx - 1 + $scope.conference.length) % $scope.conference.length];
	     $scope.nextOccasion = $scope.conference[($scope.currentOccasionIx + 1) % $scope.conference.length];
      };

	  $scope.stepOccasion = function(direction) {
	     var occasionIx = ($scope.currentOccasionIx + direction + $scope.conference.length) % $scope.conference.length;
         $scope.setOccasion(occasionIx);
	  };

      $scope.simulationTimes = [
        {name:'Refresh statistics', value: 0.0},
        {name:'1 s', value: 1.0},
        {name:'15 s', value: 15.0},
        {name:'1 min', value: 60.0},
        {name:'10 min', value: 600.0},
        {name:'1 h', value: 3600.0}
        ];
      $scope.simulationTime = $scope.simulationTimes[1];

      $scope.penaltyChoices = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20, 50, 100, 500, 1000];
      $scope.colocPenalty = $scope.penaltyChoices[0];

      $scope.commandInProgress = false;

	  $scope.stepOccasion(0);

      function updateRelationData(allRelations, relationStat) {
          $scope.allRelationStat = relationStat;
    	  $scope.relations = $scope.allRelationStat.slice(0, $scope.relationsCount);
    	  $scope.relationData = {}
    	  for(var i=0; i < allRelations.length; i++) {
    	    var relationCount = allRelations[i][2];
    	    if($scope.relationData[relationCount] !== undefined) {
    	        $scope.relationData[relationCount]++;
    	    } else {
    	        $scope.relationData[relationCount] = 1;
    	    }
    	  }
      };

      $scope.expandStat = function() {
          $scope.relationsCount += 100;
    	  $scope.relations = $scope.allRelationStat.slice(0, $scope.relationsCount);
      };

	  $scope.runSimulation = function() {
	     $scope.commandInProgress = true;
	     $http({method: 'POST', url: '/simulate',
	            data: {participant_names: $scope.participant_names,
	                   conference: $scope.conference,
	                   weight_matrix: weight_matrix,
	                   simulation_time: $scope.simulationTime['value'],
	                   coloc_penalty: $scope.colocPenalty},
	            headers: {"Content-Type": "application/json"}}).
            success(function(data, status, headers, config) {
                console.log("Received response");

                // Copy into the original conference object to avoid that the references
                // to the conference from the directives are not lost
                for(var i = 0; i < $scope.conference.length; i++) {
                    $scope.conference[i] = data['conference'][i];
                }
                updateRelationData(data['relations'], data['relation_stats']);
                updateGroupingData();
                $scope.stepOccasion(0);
                console.log("Response processed");
            }).
            error(function(data, status, headers, config) {
                console.log("Error calling simulate!")
            }).
            finally(function(data, status, headers, config) {
                $scope.commandInProgress = false;
            });
	  };

	  $scope.getResult = function() {
         $http({method: 'POST', url: '/result/excel',
                data: {participant_names: $scope.participant_names,
                       conference: $scope.conference,
                       weight_matrix: weight_matrix,
                       coloc_penalty: $scope.colocPenalty},
	            headers: {"Content-Type": "application/json"}}).
            success(function(data, status, headers, config) {
                console.log("Received file name ");

                // Dirty hack to trigger download
                angular.element($document[0].body).append("<iframe src='" + data.url + "' style='display: none;'></iframe>");
            }).
            error(function(data, status, headers, config) {
                console.log("Error getting file!")
            });
	  };

	  $scope.updateGrouping = function(occasionIx, tableIx) {
	      var tableGroupingData = [];
	      $scope.conference[occasionIx].groupingData[tableIx] = tableGroupingData;
	      var table = $scope.conference[occasionIx]['tables'][tableIx];
          for(var p=0; p < table.length; p++) {
               var groupMemberships = group_participation[table[p].id];
               for(var g=0; g < groupMemberships.length; g++) {
                   if(tableGroupingData[groupMemberships[g]] !== undefined) {
                      tableGroupingData[groupMemberships[g]]++;
                   } else {
                      tableGroupingData[groupMemberships[g]] = 1;
                   }
                }
           }
	  };

	});
  </script>

</html>